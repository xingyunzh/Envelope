var theUser=localStorage.user?JSON.parse(localStorage.user):null;$(function(){if(!theUser){window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid\x3dwxd9afdfa36e78cc2c\x26redirect_uri\x3d"+encodeURIComponent("http://www.camproz.com/envelope/myhome.html")+"\x26response_type\x3dcode\x26scope\x3dsnsapi_userinfo\x26state\x3dfromus#wechat_redirect";return}updateCount();getCollection()});
function updateCount(){httpHelper().authRequest("GET","/envelope/api/collect/count/"+theUser._id).then(function(count){$("#collected-number-span").text(count);var level=getLevelByCount(count);$(".grow-progress-block\x3eimg").attr("src","http://envelope.oss-cn-shanghai.aliyuncs.com/resource/pet_"+(level+1)+".png");$("#requiredCardCount").html(getRequiredCardCount(count))}).fail(function(error){console.log("Server Error"+JSON.stringify(error))})}
function getCollection(){httpHelper().authRequest("GET","/envelope/api/collect/cards/"+theUser._id+"?limit\x3d10").then(function(collects){var card=$(".card-sender-thumb");_.forEach(collects,function(collect,index){if(index>0){card=card.clone();$(".collected-cards-area").append(card)}else card.removeClass("hide");var image=collect.card.sender.headImgUrl?collect.card.sender.headImgUrl:"http://envelope.oss-cn-shanghai.aliyuncs.com/duola.jpg";$(".user-icon",card).attr("src",image);$(".signed-name",card).text(collect.card.sender.nickname);
$("a",card).attr("href","/envelope/api/card/view/id/"+collect.card._id);$(".collect-create-date",card).text(stamp(new Date(collect.createDate)))})}).fail(function(error){console.log("Server Error:"+JSON.stringify(error))})}function stamp(date){if(date)return date.getMonth()+1+"-"+date.getDate()+" "+date.getHours()+":"+date.getMinutes();return""};
