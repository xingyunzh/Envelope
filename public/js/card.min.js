var theUser=localStorage.user?JSON.parse(localStorage.user):null;
$(function(){if(!theSpecificSenderData.theCard){console.log("\u6b64\u4eba\u5361\u7247\u672a\u521b\u5efa!");return}wechatInit();var textIndex=theSpecificSenderData.theCard.textIndex;$("#card-text-content-span").text(theSpecificSenderData.theCard.themeConfig.textCandidates[textIndex]);$("#master-img").attr("src",theSpecificSenderData.theCard.theme.imageURL);$(".signed-name").text(theSpecificSenderData.theCard.sender.nickname);var userImage=theSpecificSenderData.theCard.sender.headImgUrl;if(!userImage)userImage=
"http://envelope.oss-cn-shanghai.aliyuncs.com/duola.jpg";$("#userIcon-img").attr("src",userImage);$(".wx_pic\x3eimg").attr("src",theSpecificSenderData.theCard.themeConfig.logoCandidates[theSpecificSenderData.theCard.logoIndex]);if(!!theUser)if(theUser._id==theSpecificSenderData.theCard.sender._id){$(".card-status-bar").hide();var query=window.location.href.split("?")[1];if(query!=null&&query.search("create")>=0){$(".card-button-a-class").removeAttr("href");$(".card-button-a-class").removeAttr("onclick");
$(".card-button-a-class").css("background-image","none");$(".card-button-a-class .inner-text-area").text("\u70b9\u51fb\u53f3\u4e0a\u89d2\u53d1\u9001\u7ed9\u670b\u53cb(\u5708)")}else $(".card-button-a-class .inner-text-area").text("\u4fee\u6539\u795d\u798f\u8bed")}else getIfCollected().then(function(collected){if(collected)$(".card-status-bar").text("\u60a8\u5df2\u7ecf\u6536\u85cf\u8fc7\u6b64\u5361\uff01");else doCollectCard()});else $(".card-status-bar").hide();updateCount()});
function wechatInit(){if(!wechatConfig)return;var card=theSpecificSenderData.theCard;wx.config({debug:false,appId:wechatConfig.appId,timestamp:wechatConfig.timestamp,nonceStr:wechatConfig.nonceStr,signature:wechatConfig.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]});wx.ready(function(){console.log("ready");wx.onMenuShareTimeline({title:card.sender.nickname+":"+card.theme.title,link:"http://www.xingyunzh.com/envelope/api/card/view/user/"+card.sender._id,imgUrl:card.themeConfig.logoCandidates[card.logoIndex],
success:function(){console.log("\u5206\u4eab\u6210\u529f")},cancel:function(){console.log("\u53d6\u6d88\u5206\u4eab")}});wx.onMenuShareAppMessage({title:card.sender.nickname+":"+card.theme.title,desc:card.themeConfig.textCandidates[card.textIndex],link:"http://www.xingyunzh.com/envelope/api/card/view/user/"+card.sender._id,imgUrl:card.themeConfig.logoCandidates[card.logoIndex],success:function(){console.log("\u5206\u4eab\u6210\u529f")},cancel:function(){console.log("\u53d6\u6d88\u5206\u4eab")}})});
wx.error(function(res){console.log("error",res)})}function updateCount(){httpHelper().authRequest("GET","/envelope/api/collect/count/"+theSpecificSenderData.theCard.sender._id).then(function(count){var birdIndex=getLevelByCount(count)+1;$("#count-span").text(""+birdIndex);$("#sprite-img").attr("src","http://envelope.oss-cn-shanghai.aliyuncs.com/resource/bird_"+birdIndex+".png")}).fail(function(error){console.log("Server Error"+JSON.stringify(error))})}
function getIfCollected(){return httpHelper().authRequest("GET","/envelope/api/collect/exist?me\x3d"+theUser._id+"\x26card\x3d"+theSpecificSenderData.theCard._id)}
function handleMyCard(){if(!!theUser)window.location.href="/envelope/myhome.html";else window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid\x3dwxd9afdfa36e78cc2c\x26redirect_uri\x3d"+encodeURIComponent("http://www.xingyunzh.com/envelope/myhome.html")+"\x26response_type\x3dcode\x26scope\x3dsnsapi_userinfo\x26state\x3d"+theSpecificSenderData.theCard.sender._id+"#wechat_redirect"}
function doCollectCard(){httpHelper().authRequest("POST","/envelope/api/collect",{sender:theSpecificSenderData.theCard.sender._id,me:theUser._id}).then(function(collect){$(".card-status-bar").show();$(".card-status-bar span").text("\u6210\u529f\u6536\u85cf\u6b64\u5361\uff01")}).fail(function(error){console.log("Server Error"+JSON.stringify(error))})};
